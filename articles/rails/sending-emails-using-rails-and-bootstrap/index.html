<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta content='IE=edge;chrome=1' http-equiv='X-UA-Compatible'>
    <meta content='width=device-width, initial-scale=1' name='viewport'>
    <title>Sending Emails Using Rails and Bootstrap</title>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/articles/feed.xml" />
    <link href="/stylesheets/all.css" rel="stylesheet" />
    <script src="/javascripts/all.js"></script>
  </head>
  <body>
    <nav class='navbar navbar-inverse navbar-static-top'>
      <div class='container'>
        <div class='navbar-header'>
          <button aria-controls='navbar' aria-expanded='false' class='navbar-toggle collapsed' data-target='#navbar' data-toggle='collapse' type='button'>
            <span class='sr-only'>Toggle navigation</span>
            <span class='icon-bar'></span>
            <span class='icon-bar'></span>
            <span class='icon-bar'></span>
          </button>
          <a class='navbar-brand' href='/'>Stefan Magnuson</a>
        </div>
        <div class='collapse navbar-collapse' id='navbar'>
          <ul class='nav navbar-nav'>
            <li class='active'>
              <a href='/'>Home</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <div class='container'>
      <h1>Sending Emails Using Rails and Bootstrap</h1>
      <p>If you&rsquo;ve built your site&rsquo;s look and feel using Bootstrap and you&rsquo;re now looking to start sending emails with similar styling then as you are no doubt aware, email clients are generally extremely limited in their understanding of CSS in particular and so we&rsquo;re going to have to do a bit of work.</p>
      
      <p>The topic of email HTML and CSS rendering is a complex one with an increasing number of caveats as you try to support more email clients. Some common client sins include:</p>
      
      <ul>
      <li>Stripping out the <code>&lt;head&gt;</code> tag completely.</li>
      <li>Not loading any linked stylesheets; all CSS must be inline, e.g. <code>&lt;div style=&quot;color: #444444; text-align: center;&quot;&gt;</code> etc.</li>
      <li>Not understanding any positional CSS, instead requiring tables within tables for layout.</li>
      <li>Generally behaving like a browser in the 90&rsquo;s.</li>
      </ul>
      
      <p>We&rsquo;ll use <code>premailer</code> to convert our linked CSS declarations into inline CSS and <code>letter_opener_web</code> to make previewing changes a little easier, then we&rsquo;ll try integrating some parts of Bootstrap in using <code>less</code>.</p>
      
      <h2>Letter Opener Web</h2>
      
      <p>It would be good to have a way to send emails locally, not worry about accidentally sending to a real person (e.g. a user) and preview the results easily. The <code>letter_opener</code> gem by Ryan Bates works well for this, but it would be nicer to be able to easily browse the emails within the app rather than only rely on them launching in a browser on each send. The <code>letter_opener_web</code> gem extends <code>letter_opener</code> with such an interface, so let&rsquo;s install it.</p>
      
      <p>Add to <code>Gemfile</code>:</p>
      <pre class="highlight ruby"><code><span class="n">gem</span> <span class="s1">'letter_opener_web'</span><span class="p">,</span> <span class="s1">'~&gt; 1.2.0'</span><span class="p">,</span> <span class="ss">:group</span> <span class="o">=&gt;</span> <span class="ss">:development</span>&#x000A;</code></pre>
      
      <p>Configure in <code>config/environments/development.rb</code>:</p>
      
      <p>If you want emails to open in your browser on send (using the <code>launchy</code> gem) and be browsable via the web interface:</p>
      <pre class="highlight ruby"><code><span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">delivery_method</span> <span class="o">=</span> <span class="ss">:letter_opener</span>&#x000A;</code></pre>
      
      <p>If you only want the emails to be visible in the web interface (I prefer this):</p>
      <pre class="highlight ruby"><code><span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">delivery_method</span> <span class="o">=</span> <span class="ss">:letter_opener_web</span>&#x000A;</code></pre>
      
      <p>Add to <code>config/routes.rb</code>:</p>
      <pre class="highlight ruby"><code><span class="k">if</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">env</span><span class="p">.</span><span class="nf">development?</span>&#x000A;  <span class="n">mount</span> <span class="no">LetterOpenerWeb</span><span class="o">::</span><span class="no">Engine</span><span class="p">,</span> <span class="ss">at: </span><span class="s2">"/devel/emails"</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre>
      
      <p>Now if you visit <code>/devel/emails</code> you should see the web interface; send some emails and they should appear here:</p>
      
      <p><img src="http://stefan.haflidason.com/assets/2014/04/Screen-Shot-2014-04-21-at-15.10.50.png" alt="Screen Shot 2014-04-21 at 15.10.50" width="782" height="290" class="aligncenter size-full wp-image-684" style="border: 1px solid #444;" /></p>
      
      <h2>Premailer</h2>
      
      <h3>Installation</h3>
      
      <p>Add <code>nokogiri</code> and <code>premailer-rails</code> to your <code>Gemfile</code>:</p>
      <pre class="highlight ruby"><code><span class="n">gem</span> <span class="s1">'nokogiri'</span>&#x000A;<span class="n">gem</span> <span class="s1">'premailer-rails'</span>&#x000A;</code></pre>
      
      <p>(and run <code>bundle install</code>)</p>
      
      <p>Premailer will hook in to the email rendering process of <code>ActionMailer</code> automatically.</p>
      
      <h2>Testing it Out</h2>
      
      <p>To test that it&rsquo;s working as expected, we&rsquo;ll just define a couple of simple classes in a new CSS file, <code>app/assets/stylesheets/emails.css.less</code>:</p>
      <pre class="highlight css"><code><span class="nc">.red</span> <span class="p">{</span>&#x000A;  <span class="nl">color</span><span class="p">:</span> <span class="no">red</span><span class="p">;</span>&#x000A;<span class="p">}</span>&#x000A;&#x000A;<span class="nc">.bold</span> <span class="p">{</span>&#x000A;  <span class="nl">font-weight</span><span class="p">:</span> <span class="nb">bold</span><span class="p">;</span>&#x000A;<span class="p">}</span>&#x000A;</code></pre>
      
      <p>And then in our email view template (<code>app/views/notifier/daily_summary.html.haml</code>), we&rsquo;ll link in the CSS file and make use of the classes:</p>
      <pre class="highlight haml"><code><span class="nn">!!!&#x000A;</span><span class="nt">%html</span>&#x000A;  <span class="nt">%head</span>&#x000A;    <span class="nt">%meta</span><span class="p">(</span><span class="na">http-equiv=</span><span class="s">"Content-Type"</span> <span class="na">content=</span><span class="s">"text/html; charset=UTF-8"</span>)&#x000A;    <span class="p">=</span><span class="n">stylesheet_link_tag</span> <span class="s1">'emails.css'</span>&#x000A;  <span class="nt">%body</span>&#x000A;    <span class="nt">%p</span><span class="nc">.red.bold</span> A test email&#x000A;</code></pre>
      
      <p>We send this email via the console:</p>
      <pre class="highlight ruby"><code><span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="no">Notifier</span><span class="p">.</span><span class="nf">daily_summary</span><span class="p">.</span><span class="nf">deliver</span>&#x000A;</code></pre>
      
      <p>And the resulting <code>&lt;p&gt;</code> tag has the classes defined as expected, including the relevant declarations pulled in as inline styling:</p>
      <pre class="highlight html"><code><span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"red bold"</span> <span class="na">style=</span><span class="s">"color: red; font-weight: bold"</span><span class="nt">&gt;</span>A test email<span class="nt">&lt;/p&gt;</span>&#x000A;</code></pre>
      
      <p>Inspecting the email, we see that this is basically working, though it isn&rsquo;t a proper test yet as we are using a modern browser and not an email client.</p>
      
      <h2>Incorporating Bootstrap</h2>
      
      <p>I&rsquo;ll assume that you already have Bootstrap incorporated into your asset pipeline using the source less files. Using SCSS would work fine too; what we want to do is to import the parts of Bootstrap that would be useful for styling our emails and this could even be achieved using static CSS, though I wouldn&rsquo;t recommend it.</p>
      
      <p>We start by importing some Bootstrap less files into <code>emails.css.less</code>:</p>
      <pre class="highlight css"><code><span class="o">//</span> <span class="nt">Core</span> <span class="nt">variables</span> <span class="nt">and</span> <span class="nt">mixins</span>&#x000A;<span class="k">@import</span> <span class="s1">"twitter/bootstrap/variables.less"</span><span class="p">;</span>&#x000A;<span class="k">@import</span> <span class="s1">"twitter/bootstrap/mixins.less"</span><span class="p">;</span>&#x000A;&#x000A;<span class="o">//</span> <span class="nt">Theme</span> <span class="nt">variables</span> <span class="nt">and</span> <span class="nt">mixins</span>&#x000A;<span class="k">@import</span> <span class="s1">"theme/mixins.less"</span><span class="p">;</span>&#x000A;<span class="k">@import</span> <span class="s1">"theme/variables.less"</span><span class="p">;</span>&#x000A;&#x000A;<span class="o">//</span> <span class="nt">Reset</span>&#x000A;<span class="k">@import</span> <span class="s1">"twitter/bootstrap/normalize.less"</span><span class="p">;</span>&#x000A;&#x000A;<span class="o">//</span> <span class="nt">Core</span> <span class="nt">CSS</span>&#x000A;<span class="k">@import</span> <span class="s1">"twitter/bootstrap/scaffolding.less"</span><span class="p">;</span>&#x000A;<span class="k">@import</span> <span class="s1">"twitter/bootstrap/type.less"</span><span class="p">;</span>&#x000A;<span class="k">@import</span> <span class="s1">"twitter/bootstrap/code.less"</span><span class="p">;</span>&#x000A;<span class="k">@import</span> <span class="s1">"twitter/bootstrap/grid.less"</span><span class="p">;</span>&#x000A;<span class="k">@import</span> <span class="s1">"twitter/bootstrap/tables.less"</span><span class="p">;</span>&#x000A;<span class="k">@import</span> <span class="s1">"twitter/bootstrap/forms.less"</span><span class="p">;</span>&#x000A;<span class="k">@import</span> <span class="s1">"twitter/bootstrap/buttons.less"</span><span class="p">;</span>&#x000A;&#x000A;<span class="o">//</span> <span class="nt">Components</span>&#x000A;<span class="k">@import</span> <span class="s1">"twitter/bootstrap/labels.less"</span><span class="p">;</span>&#x000A;<span class="k">@import</span> <span class="s1">"twitter/bootstrap/badges.less"</span><span class="p">;</span>&#x000A;<span class="k">@import</span> <span class="s1">"twitter/bootstrap/panels.less"</span><span class="p">;</span>&#x000A;</code></pre>
      
      <p>We&rsquo;ve imported the foundational files and a few components; at this stage it isn&rsquo;t clear what components are going to work with this setup, in email clients or otherwise.</p>
      
      <p>Then we extend our email template to make use of some Bootstrap classes:</p>
      <pre class="highlight haml"><code><span class="nn">!!!&#x000A;</span><span class="nt">%html</span>&#x000A;  <span class="nt">%head</span>&#x000A;    <span class="nt">%meta</span><span class="p">(</span><span class="na">http-equiv=</span><span class="s">"Content-Type"</span> <span class="na">content=</span><span class="s">"text/html; charset=UTF-8"</span>)&#x000A;    <span class="p">=</span><span class="n">stylesheet_link_tag</span> <span class="s1">'emails.css'</span>&#x000A;  <span class="nt">%body</span>&#x000A;    <span class="nt">%h2</span> Tables&#x000A;&#x000A;    <span class="nt">%table</span><span class="nc">.table</span>&#x000A;      <span class="nt">%thead</span>&#x000A;        <span class="nt">%tr</span>&#x000A;          <span class="nt">%th</span> Column 1&#x000A;          <span class="nt">%th</span> Column 2&#x000A;      <span class="nt">%tbody</span>&#x000A;        <span class="nt">%tr</span>&#x000A;          <span class="nt">%td</span> 1 / 1&#x000A;          <span class="nt">%td</span> 1 / 2&#x000A;        <span class="nt">%tr</span>&#x000A;          <span class="nt">%td</span> 2 / 1&#x000A;          <span class="nt">%td</span> 2 / 2&#x000A;&#x000A;    <span class="nt">%h2</span> Links&#x000A;&#x000A;    <span class="nt">%a</span><span class="nc">.btn.btn-primary</span><span class="p">(</span><span class="na">href=</span><span class="s">"#"</span>)&#x000A;      Link Styled as Button&#x000A;&#x000A;    <span class="nt">%br</span>&#x000A;    <span class="nt">%br</span>&#x000A;&#x000A;    <span class="nt">%a</span>&#x000A;      Link with badge&#x000A;      <span class="nt">%span</span><span class="nc">.badge</span> 42&#x000A;&#x000A;    <span class="nt">%br</span>&#x000A;    <span class="nt">%br</span>&#x000A;&#x000A;    <span class="nt">%h2</span> Panels&#x000A;&#x000A;    <span class="nc">.panel.panel-primary</span>&#x000A;      <span class="nc">.panel-heading</span>&#x000A;        Panel Heading&#x000A;      <span class="nc">.panel-body</span>&#x000A;        Panel Body&#x000A;&#x000A;        <span class="nc">.label.label-primary</span>&#x000A;          Primary Label&#x000A;&#x000A;        <span class="nc">.label.label-warning</span>&#x000A;          Warning Label&#x000A;&#x000A;        <span class="nc">.label.label-danger</span>&#x000A;          Danger Label&#x000A;</code></pre>
      
      <h2>Results</h2>
      
      <p><img src="http://stefan.haflidason.com/assets/2014/04/Screen-Shot-2014-04-21-at-16.32.33.png" alt="Screen Shot 2014-04-21 at 16.32.33" width="900" height="640" class="aligncenter size-full wp-image-694" /></p>
      
      <p>Some components simply aren&rsquo;t going to work at all, so I&rsquo;m expecting that the main benefit will be access to variables and mixins. This will help reduce code duplication and it won&rsquo;t add quite as much weight as including the rest of the framework, so overall I would recommend getting as much mileage from simple HTML/CSS and the variables/mixins before spending too much time trying to get components to render properly.</p>
      
      <p>Trying the resulting HTML in various email clients (via <a href="https://litmus.com/pub/d831ecc">Litmus</a>) results in reasonable results for a first attempt; some clients are nearly there, though some are quite broken. With tweaking this may be viable, though the recommendation to not spend too much time on the components still stands.</p>
      
      <p><a href="https://litmus.com/pub/d831ecc" target="_blank"><img src="http://stefan.haflidason.com/assets/2014/04/Screen-Shot-2014-04-21-at-16.49.37.png" alt="Screen Shot 2014-04-21 at 16.49.37" width="939" height="448" class="aligncenter size-full wp-image-695" /></a></p>
      
      <p>In order to get going quickly I&rsquo;ll be starting with one of the battle-tested templates that <a href="https://github.com/mailchimp/email-blueprints">Mailchimp has open sourced</a>. From there it will simply be a case of carefully linking up the Bootstrap style variables (e.g. colours) with the provided HTML. As long as no drastic changes are introduced, and the automatic inlining done by Premailer doesn&rsquo;t break anything, then we should get widely-compatible email templates for our Rails app with a relatively small time investment.</p>
      <hr>
      <div class='text-center'>
        <p>Did you find this post useful? If you would like help with anything then you can contact me any time via <a href="https://twitter.com/styrmis" target="_blank">Twitter</a>.</p>
        <br>
        <p>Also if this kind of work interests you, my employer Mystery Applicant <a href="https://mysteryapplicant.workable.com/jobs/489994" target="_blank">is hiring</a>.</p>
        <br>
      </div>
    </div>
    <script type="text/javascript">
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-95628-24', 'auto');
      ga('send', 'pageview');
    </script>
  </body>
</html>
