<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta content='IE=edge;chrome=1' http-equiv='X-UA-Compatible'>
    <meta content='width=device-width, initial-scale=1' name='viewport'>
    <title>Notes on the use of Staging Environments on Heroku</title>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/articles/feed.xml" />
    <link href="/stylesheets/all.css" rel="stylesheet" />
    <script src="/javascripts/all.js"></script>
  </head>
  <body>
    <nav class='navbar navbar-inverse navbar-static-top'>
      <div class='container'>
        <div class='navbar-header'>
          <button aria-controls='navbar' aria-expanded='false' class='navbar-toggle collapsed' data-target='#navbar' data-toggle='collapse' type='button'>
            <span class='sr-only'>Toggle navigation</span>
            <span class='icon-bar'></span>
            <span class='icon-bar'></span>
            <span class='icon-bar'></span>
          </button>
          <a class='navbar-brand' href='/'>Stefan Magnuson</a>
        </div>
        <div class='collapse navbar-collapse' id='navbar'>
          <ul class='nav navbar-nav'>
            <li class='active'>
              <a href='/'>Home</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <div class='container'>
      <h1>Notes on the use of Staging Environments on Heroku</h1>
      <p>The setup and use of a separate staging environment is covered (almost)
      adequately by <a href="https://devcenter.heroku.com/articles/fork-app">Heroku&rsquo;s documentation on the matter</a>.</p>
      
      <p>And yet I must be missing something, as forking my app didn&rsquo;t do what I
      expected.</p>
      
      <p>In forking a running production app to create a staging clone environment what I
      expected to have afterwards was:</p>
      
      <ul>
      <li>A Heroku app called <code>appname-staging</code>, running the same version of the
      application</li>
      <li>A newly-created hobby-dev Postgres instance containing the production data</li>
      <li>That the staging app should be targeting the new staging database, i.e.
      <code>DATABASE_URL</code> for <code>appname-staging</code> should be set to the URL of the
      newly-created database.</li>
      </ul>
      
      <p>The staging app appeared to be working exactly as expected. There was a new
      database which contained a copy of the production database, the staging app was
      running the right version of the code at the appropriate URL, and it appeared to
      be a perfect clone of production.</p>
      
      <p>Unbelievably (for me at least), the <code>DATABASE_URL</code> of the new staging app was
      set to point to the production database, including credentials. Staging was
      masquerading as a perfect clone of production because it was in fact pointing to
      the production database.</p>
      
      <p>Here is the relevant portion of the Heroku documentation:</p>
      
      <blockquote>
      <p>It is recommended to make sure if you have an expected Heroku Postgres setup
      with your target app. Please run heroku pg:info and/or heroku config command
      to make sure that everything has copied as you expected. If the copied
      database is not being the primary database (DATABASE_URL), use heroku
      pg:promote as described by the Heroku Postgres documentation to make it a
      primary database.</p>
      </blockquote>
      
      <p>It does not inspire confidence that this important caveat is not highlighted
      more clearly, and the concepts involved not explained in more detail. In what
      case would we ever want to fork an app, and have it pointing at the live
      production database?</p>
      
      <p>Another potentially important caveat, while we are <em>forking</em> the app, the
      database will be <em>copied</em>, i.e. the database will not be <em>forked</em> using the
      provided <em>fork</em> feature. This lack of clarity has likely tripped up enough
      people for them to warrant adding another warning to the documentation page.</p>
      
      <p>I have not found these issues discussed much (or at all) online, so I can only
      assume that I am one of the few who has fallen foul of this. Still, if you are
      experimenting with staging environments on Heroku then I would recommend
      checking and double-checking the config of the new app (as they do indeed
      suggest). Heroku reduces many complex hosting-related concerns to simple
      commands and it&rsquo;s easy to get used to that, but it seems that not all of these
      commands receive the same polish and attention.</p>
      
      <p>Final caveat (hopefuly) is that Heroku will not necessarily use the same
      Postgres version: my production 9.3 database was cloned to a new instance
      running Postgres 9.5.</p>
      
      <h2>Resolving the issue</h2>
      
      <p><strong>NOTE:</strong> Double and triple-check all commands before running them&ndash;the point of
      the article is that Heroku&rsquo;s simple tooling can make it equally simple to
      compromise your production deployment.</p>
      
      <h3>The Situation</h3>
      
      <p>You have run Heroku&rsquo;s <code>fork</code> command and now have a clone of your production
      app, but its <code>DATABASE_URL</code> is still pointing to that of production.</p>
      
      <p>First, take a fresh backup of production before continuing:</p>
      
      <p><code>% heroku pg:backups capture -a production-app-name</code></p>
      
      <p><code>% curl `heroku pg:backups public-url -a production-app-name` -o `date +5Y5m5d`.pgbackup</code></p>
      
      <p>With a backup safely stored, we look at the configuration of each application:</p>
      <pre class="highlight plaintext"><code>% heroku config -a production-app-name | grep URL&#x000A;DATABASE_URL:               postgres://user_a:password@ec2-host1.eu-west-1.compute.amazonaws.com:5432/db_identifier1&#x000A;HEROKU_POSTGRESQL_ROSE_URL: postgres://user_a:password@ec2-host1.eu-west-1.compute.amazonaws.com:5432/db_identifier1&#x000A;% heroku config -a staging-app-name | grep URL&#x000A;DATABASE_URL:               postgres://user_a:password@ec2-host1.eu-west-1.compute.amazonaws.com:5432/db_identifier1&#x000A;HEROKU_POSTGRESQL_ROSE_URL: postgres://user_b:password@ec2-host2.eu-west-1.compute.amazonaws.com:5432/db_identifier2&#x000A;</code></pre>
      
      <p>Note that the staging app has a new <code>ROSE</code> database URL, and yet its
      <code>DATABASE_URL</code> is still pointing directly at production.</p>
      
      <p>In the remaining configuration items, new credentials have been automatically
      set for New Relic, Papertrail and other add-ons, but for some reason not for the
      all-important <code>DATABASE-URL</code>.</p>
      
      <h3>The Solution</h3>
      
      <p>As per <a href="https://devcenter.heroku.com/articles/heroku-postgresql#establish-primary-db">Heroku&rsquo;s docs on the
      matter</a>,
      we need to <em>promote</em> the newly-created staging database to be the primary
      database for the app:</p>
      <pre class="highlight plaintext"><code>% heroku pg:promote HEROKU_POSTGRESQL_ROSE_URL -a staging-app-name&#x000A;Ensuring an alternate alias for existing DATABASE... done, not needed&#x000A;Promoting postgresql-addon-id to DATABASE_URL on staging-app-name... done&#x000A;</code></pre>
      
      <p>We now confirm that the production configuration has not changed, and the
      staging configuration now has <code>DATABASE_URL</code> pointing at the new staging
      database, and <strong>not</strong> our production database:</p>
      <pre class="highlight plaintext"><code>% heroku config -a production-app-name | grep URL&#x000A;DATABASE_URL:               postgres://user_a:password@ec2-host1.eu-west-1.compute.amazonaws.com:5432/db_identifier1&#x000A;HEROKU_POSTGRESQL_ROSE_URL: postgres://user_a:password@ec2-host1.eu-west-1.compute.amazonaws.com:5432/db_identifier1&#x000A;% heroku config -a staging-app-name | grep URL&#x000A;DATABASE_URL:               postgres://user_b:password@ec2-host2.eu-west-1.compute.amazonaws.com:5432/db_identifier2&#x000A;HEROKU_POSTGRESQL_ROSE_URL: postgres://user_b:password@ec2-host2.eu-west-1.compute.amazonaws.com:5432/db_identifier2&#x000A;</code></pre>
      
      <h2>Updating the staging database</h2>
      
      <p>At some point you will want to refresh the data in staging. This can be achieved
      using the <code>pg:copy</code> command, though the first time through the output of the
      command will likely give you pause for thought:</p>
      <pre class="highlight plaintext"><code>% heroku pg:copy production-app-name::ROSE staging-app-name::ROSE --app staging-app-name&#x000A;&#x000A; !    WARNING: Destructive Action&#x000A; !    This command will remove all data from ROSE&#x000A; !    Data from ROSE will then be transferred to ROSE&#x000A; !    This command will affect the app: staging-app-name&#x000A; !    To proceed, type "staging-app-name or re-run this command with --confirm staging-app-name&#x000A;&#x000A;&gt; ^C !    Command cancelled.&#x000A;</code></pre>
      
      <p>If I could find clear guidance on how I should go about changing the colour name
      of my staging database I would do so, to avoid the unpleasant ambiguity in the
      destructive action warning.</p>
      
      <p>For now, the fact that I am explicitly targetting the staging app <em>should</em>
      protect the production environment, though as we have seen this protection can
      easily be bypassed by the <code>fork</code> command as it shares the <code>DATABASE_URL</code> between
      the apps.</p>
      
      <p>Allow the command to run and hopefully you should now have an up-to-date staging
      database.</p>
      <hr>
      <div class='text-center'>
        <p>Did you find this post useful? If you would like help with anything then you can contact me any time via <a href="https://twitter.com/styrmis" target="_blank">Twitter</a>.</p>
        <br>
        <p>Also if this kind of work interests you, my employer Mystery Applicant <a href="https://mysteryapplicant.workable.com/jobs/489994" target="_blank">is hiring</a>.</p>
        <br>
      </div>
    </div>
    <script type="text/javascript">
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-95628-24', 'auto');
      ga('send', 'pageview');
    </script>
  </body>
</html>
